<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë©”ë””ì…œ ì˜ì–‘ì œ ì²´í¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ì˜ì–‘ì œì²´í¬">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-tertiary: #f1f5f9;
  --bg-page: #eef2ff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --accent: #2563eb;
  --accent-dark: #1d4ed8;
  --accent-deeper: #1e40af;
  --accent-bg: #eff6ff;
  --accent-border: #93c5fd;
  --green: #22c55e;
  --green-bg: #f0fdf4;
  --green-border: #bbf7d0;
  --red: #dc2626;
  --red-bg: #fef2f2;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 28px rgba(0,0,0,0.08);
  --card-hover: 0 4px 16px rgba(0,0,0,0.05);
  --nav-bg: rgba(255,255,255,0.92);
  --nav-border: #e2e8f0;
  --modal-overlay: rgba(15, 23, 42, 0.5);
}

[data-theme="dark"] {
  --bg-primary: #1e1e2e;
  --bg-secondary: #262637;
  --bg-tertiary: #2e2e42;
  --bg-page: #13131d;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #3b3b54;
  --border-light: #2e2e42;
  --accent: #60a5fa;
  --accent-dark: #3b82f6;
  --accent-deeper: #2563eb;
  --accent-bg: rgba(59,130,246,0.12);
  --accent-border: rgba(96,165,250,0.3);
  --green: #4ade80;
  --green-bg: rgba(74,222,128,0.1);
  --green-border: rgba(74,222,128,0.25);
  --red: #f87171;
  --red-bg: rgba(248,113,113,0.1);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.25);
  --shadow-lg: 0 8px 28px rgba(0,0,0,0.3);
  --card-hover: 0 4px 16px rgba(0,0,0,0.2);
  --nav-bg: rgba(30,30,46,0.95);
  --nav-border: #3b3b54;
  --modal-overlay: rgba(0, 0, 0, 0.7);
}

* { margin: 0; padding: 0; box-sizing: border-box; touch-action: pan-x pan-y; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-page);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

.app {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  background: var(--bg-primary);
  box-shadow: 0 0 40px rgba(30, 64, 175, 0.08);
  animation: appFadeIn 0.6s ease;
  padding-bottom: 80px;
}
@keyframes appFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Header */
.header {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #1e40af 100%);
  color: #fff;
  padding: 24px 20px 28px;
  position: relative;
  overflow: hidden;
}
[data-theme="dark"] .header {
  background: linear-gradient(135deg, #1e3a5f 0%, #1a2744 50%, #162032 100%);
}
.header::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle at 30% 40%, rgba(255,255,255,0.1) 0%, transparent 60%);
  animation: headerShimmer 8s ease-in-out infinite alternate;
}
@keyframes headerShimmer {
  0% { transform: translate(0, 0); }
  100% { transform: translate(10%, 5%); }
}
.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}
.header-info {
  flex: 1;
}
.header h1 {
  font-size: 1.35rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header .date {
  font-size: 0.82rem;
  opacity: 0.8;
  margin-top: 4px;
  font-weight: 400;
}

/* Header bottom row */
.header-bottom {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 16px;
  position: relative;
}

/* Dark mode toggle */
.dark-toggle {
  position: relative;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.1);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: all 0.3s;
  flex-shrink: 0;
  backdrop-filter: blur(4px);
}
.dark-toggle:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

/* Progress Ring in Header */
.header-progress {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
  position: relative;
}
.progress-ring-wrap {
  position: relative;
  width: 56px;
  height: 56px;
  flex-shrink: 0;
}
.progress-ring-wrap svg {
  transform: rotate(-90deg);
}
.progress-ring-bg {
  fill: none;
  stroke: rgba(255,255,255,0.2);
  stroke-width: 5;
}
.progress-ring-bar {
  fill: none;
  stroke: #fff;
  stroke-width: 5;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.progress-ring-text {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.78rem;
  font-weight: 800;
  color: #fff;
}
.progress-detail {
  font-size: 0.82rem;
  color: rgba(255,255,255,0.85);
  line-height: 1.5;
}
.progress-detail strong {
  color: #fff;
  font-weight: 700;
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: var(--nav-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--nav-border);
  display: flex;
  z-index: 50;
  padding-bottom: env(safe-area-inset-bottom, 0);
}
.nav-item {
  flex: 1;
  padding: 10px 0 8px;
  text-align: center;
  cursor: pointer;
  border: none;
  background: none;
  color: var(--text-muted);
  font-family: 'Inter', sans-serif;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
}
.nav-item .nav-icon {
  font-size: 1.3rem;
  line-height: 1;
  transition: transform 0.3s;
}
.nav-item .nav-label {
  font-size: 0.68rem;
  font-weight: 600;
  letter-spacing: 0.3px;
}
.nav-item.active {
  color: var(--accent);
}
.nav-item.active .nav-icon {
  transform: scale(1.15);
}
.nav-item.active::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 28px;
  height: 3px;
  background: var(--accent);
  border-radius: 0 0 3px 3px;
}

/* Tab content */
.tab-content {
  display: none;
  padding: 20px 16px;
  animation: tabFadeIn 0.4s ease;
}
.tab-content.active { display: block; }
@keyframes tabFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Today tab - Empty State */
.today-empty {
  text-align: center;
  padding: 50px 20px;
  color: var(--text-muted);
  animation: fadeInUp 0.5s ease;
}
.today-empty .empty-icon {
  font-size: 3.5rem;
  margin-bottom: 16px;
  display: block;
  animation: emptyBounce 2s ease-in-out infinite;
}
@keyframes emptyBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
.today-empty .empty-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.today-empty .empty-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  line-height: 1.5;
}

/* Completion celebration */
.completion-banner {
  text-align: center;
  padding: 28px 20px;
  background: linear-gradient(135deg, var(--green-bg), #dcfce7);
  border-radius: 18px;
  margin-bottom: 20px;
  border: 1px solid var(--green-border);
  animation: celebrateIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
[data-theme="dark"] .completion-banner {
  background: linear-gradient(135deg, rgba(74,222,128,0.08), rgba(74,222,128,0.15));
}
@keyframes celebrateIn {
  0% { opacity: 0; transform: scale(0.8); }
  100% { opacity: 1; transform: scale(1); }
}
.completion-banner .celebrate-icon {
  font-size: 2.8rem;
  display: block;
  margin-bottom: 10px;
  animation: celebrateBounce 1s ease-in-out infinite;
}
@keyframes celebrateBounce {
  0% { transform: scale(1) rotateY(0deg); }
  50% { transform: scale(1.1) rotateY(180deg); }
  100% { transform: scale(1) rotateY(360deg); }
}
.completion-banner .celebrate-title {
  font-size: 1.1rem;
  font-weight: 800;
  color: var(--green);
  margin-bottom: 4px;
}
.completion-banner .celebrate-desc {
  font-size: 0.82rem;
  color: var(--text-secondary);
}

/* Care Message */
.care-message {
  text-align: center;
  padding: 18px 20px;
  background: var(--bg-secondary);
  border-radius: 14px;
  margin-bottom: 18px;
  border: 1px solid var(--border-light);
  animation: fadeInUp 0.6s ease both;
}
.care-message.done {
  background: linear-gradient(135deg, var(--green-bg), #dcfce7);
  border-color: var(--green-border);
}
[data-theme="dark"] .care-message.done {
  background: linear-gradient(135deg, rgba(74,222,128,0.06), rgba(74,222,128,0.12));
}
.care-message .care-icon {
  font-size: 1.4rem;
  display: block;
  margin-bottom: 6px;
}
.care-message .care-text {
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--text-secondary);
  line-height: 1.5;
}
.care-message.done .care-text {
  color: var(--green);
}


.time-group {
  margin-bottom: 24px;
  animation: fadeInUp 0.5s ease both;
}
.time-group:nth-child(2) { animation-delay: 0.1s; }
.time-group:nth-child(3) { animation-delay: 0.2s; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.time-group-label {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 10px;
  padding-left: 4px;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.time-group-label::before {
  content: '';
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  display: inline-block;
}

.supp-card {
  display: flex;
  align-items: center;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 14px;
  margin-bottom: 10px;
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  gap: 14px;
  border: 1px solid var(--border-light);
}
.supp-card:hover {
  background: var(--bg-tertiary);
  transform: translateX(4px);
}
.supp-card.checked {
  background: var(--green-bg);
  border-color: var(--green-border);
}
.supp-card.checked:hover { background: var(--green-bg); }
.supp-card .check-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2.5px solid #cbd5e1;
  background: var(--bg-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 14px;
  color: transparent;
}
.supp-card .check-btn:hover {
  border-color: var(--green);
  transform: scale(1.1);
}
.supp-card.checked .check-btn {
  background: var(--green);
  border-color: var(--green);
  color: #fff;
  animation: checkPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes checkPop {
  0% { transform: scale(0.8); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.supp-card .info { flex: 1; }
.supp-card .name {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--text-primary);
  transition: all 0.3s;
}
.supp-card.checked .name {
  text-decoration: line-through;
  color: var(--text-muted);
}
.supp-card .detail {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 3px;
}
.supp-card .stock-badge {
  font-size: 0.72rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  background: #e0e7ff;
  color: #3b82f6;
  flex-shrink: 0;
  transition: all 0.3s;
}
.supp-card .stock-badge.low {
  background: var(--red-bg);
  color: var(--red);
  animation: lowPulse 2s ease-in-out infinite;
}
@keyframes lowPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Confetti */
.confetti-container {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 200;
  overflow: hidden;
}
.confetti-piece {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 2px;
  animation: confettiFall 1.2s ease-out forwards;
}
@keyframes confettiFall {
  0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
  100% { opacity: 0; transform: translateY(600px) rotate(720deg) scale(0.3); }
}

/* Stats tab */
.stat-period {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}
.period-btn {
  flex: 1;
  padding: 10px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  background: var(--bg-primary);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Inter', sans-serif;
}
.period-btn:hover { border-color: var(--accent-border); color: var(--accent); }
.period-btn.active {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
[data-theme="dark"] .period-btn.active {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
}

/* Savings Hero */
.savings-hero {
  text-align: center;
  padding: 28px 20px;
  margin-bottom: 24px;
  border-radius: 18px;
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  border: 1.5px solid #fbbf24;
  box-shadow: 0 0 12px rgba(251,191,36,0.2);
  animation: fadeInUp 0.5s ease;
}
[data-theme="dark"] .savings-hero {
  background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(245,158,11,0.15));
  border-color: #f59e0b;
  box-shadow: 0 0 12px rgba(245,158,11,0.15);
}
.savings-hero-icon {
  font-size: 2.8rem;
  margin-bottom: 8px;
  animation: celebrateBounce 1s ease-in-out infinite;
}
.savings-hero-amount {
  font-size: 2.2rem;
  font-weight: 800;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.2;
}
.savings-hero-label {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-top: 4px;
  margin-bottom: 16px;
}
.savings-hero-bar-wrap {
  max-width: 280px;
  margin: 0 auto;
}
.savings-hero-bar {
  height: 10px;
  background: rgba(251,191,36,0.2);
  border-radius: 5px;
  overflow: hidden;
}
.savings-hero-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #f59e0b, #fbbf24);
  border-radius: 5px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.savings-hero-bar-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.68rem;
  color: var(--text-muted);
  margin-top: 4px;
  font-weight: 500;
}

/* Streak badge */
.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(135deg, rgba(249,115,22,0.5), rgba(239,68,68,0.45));
  color: #fff;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  white-space: nowrap;
  backdrop-filter: blur(4px);
  position: relative;
  overflow: hidden;
  text-shadow: 0 1px 4px rgba(0,0,0,0.2);
  animation: streakGlow 2s ease-in-out infinite;
}
@keyframes streakGlow {
  0%, 100% { box-shadow: 0 0 8px rgba(249,115,22,0.3), 0 0 2px rgba(239,68,68,0.2); }
  50% { box-shadow: 0 0 16px rgba(249,115,22,0.5), 0 0 6px rgba(239,68,68,0.4); }
}
.streak-badge::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle at 30% 50%, rgba(255,200,50,0.25) 0%, transparent 60%);
  animation: streakShimmer 3s ease-in-out infinite alternate;
}
@keyframes streakShimmer {
  0% { transform: translate(0, 0); }
  100% { transform: translate(20%, -10%); }
}
.streak-badge .streak-fire {
  font-size: 0.9rem;
  animation: fireFlicker 0.8s ease-in-out infinite alternate;
  filter: drop-shadow(0 0 3px rgba(249,115,22,0.6));
}
@keyframes fireFlicker {
  0% { transform: scale(1) rotate(-3deg); }
  50% { transform: scale(1.15) rotate(3deg); }
  100% { transform: scale(1.05) rotate(-2deg); }
}

.stat-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 28px;
}
.stat-box {
  flex: 1;
  text-align: center;
  padding: 18px 8px;
  background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
  border-radius: 16px;
  border: 1px solid var(--border);
  transition: all 0.3s;
  animation: fadeInUp 0.5s ease both;
}
.stat-box:nth-child(1) { animation-delay: 0s; }
.stat-box:nth-child(2) { animation-delay: 0.1s; }
.stat-box:nth-child(3) { animation-delay: 0.2s; }
.stat-box:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}
.stat-box .value {
  font-size: 1.7rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.stat-box .label {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-top: 6px;
  letter-spacing: 0.3px;
}

/* Stats empty */
.stats-empty {
  text-align: center;
  padding: 50px 20px;
  animation: fadeInUp 0.5s ease;
}
.stats-empty .empty-icon {
  font-size: 3.5rem;
  margin-bottom: 16px;
  display: block;
  animation: emptyBounce 2s ease-in-out infinite;
}
.stats-empty .empty-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.stats-empty .empty-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.chart-section h3 {
  font-size: 0.9rem;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
}
.chart-bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
  gap: 10px;
  animation: fadeInUp 0.5s ease both;
}
.chart-bar-row:nth-child(1) { animation-delay: 0s; }
.chart-bar-row:nth-child(2) { animation-delay: 0.08s; }
.chart-bar-row:nth-child(3) { animation-delay: 0.16s; }
.chart-bar-row:nth-child(4) { animation-delay: 0.24s; }
.chart-bar-label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-secondary);
  width: 72px;
  text-align: right;
  flex-shrink: 0;
  word-break: keep-all;
}
.chart-bar-track {
  flex: 1;
  height: 24px;
  background: var(--bg-tertiary);
  border-radius: 12px;
  overflow: hidden;
}
.chart-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #2563eb, #1d4ed8);
  border-radius: 12px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  min-width: 0;
  position: relative;
}
.chart-bar-fill::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
}
.chart-bar-value {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--accent);
  width: 40px;
  flex-shrink: 0;
}

/* Manage tab */
.add-btn {
  width: 100%;
  padding: 16px;
  border: 2px dashed var(--border);
  border-radius: 14px;
  background: var(--bg-secondary);
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 18px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Inter', sans-serif;
}
.add-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-bg);
  transform: translateY(-2px);
}

/* Manage empty */
.manage-empty {
  text-align: center;
  padding: 50px 20px;
  animation: fadeInUp 0.5s ease;
}
.manage-empty .empty-icon {
  font-size: 3.5rem;
  margin-bottom: 16px;
  display: block;
  animation: emptyBounce 2s ease-in-out infinite;
}
.manage-empty .empty-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.manage-empty .empty-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.manage-card {
  background: var(--bg-secondary);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border-light);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: fadeInUp 0.4s ease both;
}
.manage-card:hover {
  box-shadow: var(--card-hover);
  transform: translateY(-2px);
}
.manage-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.manage-card-header .name { font-weight: 700; font-size: 0.95rem; color: var(--text-primary); }
.manage-card-actions {
  display: flex;
  gap: 6px;
}
.manage-card-actions button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  padding: 6px;
  color: var(--text-muted);
  border-radius: 8px;
  transition: all 0.2s;
}
.manage-card-actions button:hover { color: var(--accent); background: var(--accent-bg); }
.manage-card-actions .delete-btn:hover { color: var(--red); background: var(--red-bg); }
.manage-card .detail-row {
  font-size: 0.82rem;
  color: var(--text-muted);
  font-weight: 500;
}
.manage-card .stock-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--modal-overlay);
  backdrop-filter: blur(4px);
  z-index: 100;
  justify-content: center;
  align-items: flex-end;
}
.modal-overlay.active {
  display: flex;
  animation: overlayFadeIn 0.3s ease;
}
@keyframes overlayFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal {
  background: var(--bg-primary);
  border-radius: 24px 24px 0 0;
  padding: 28px 24px 32px;
  width: 100%;
  max-width: 480px;
  max-height: 85vh;
  overflow-y: auto;
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.modal::before {
  content: '';
  display: block;
  width: 40px;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 0 auto 20px;
}
.modal h2 {
  font-size: 1.15rem;
  font-weight: 700;
  margin-bottom: 24px;
  text-align: center;
  color: var(--text-primary);
}
.form-group {
  margin-bottom: 18px;
}
.form-group label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  letter-spacing: 0.3px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  font-size: 0.95rem;
  font-family: 'Inter', sans-serif;
  outline: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: var(--bg-secondary);
  color: var(--text-primary);
}
.form-group input:focus, .form-group select:focus {
  border-color: var(--accent);
  background: var(--bg-primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}
.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 24px;
}
.form-actions button {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: none;
  font-size: 0.95rem;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn-cancel {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}
.btn-cancel:hover { background: var(--border); }
.btn-save {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
.btn-save:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}

/* Notification permission banner */
.notif-banner {
  display: none;
  background: linear-gradient(90deg, #fef3c7, #fde68a);
  padding: 14px 16px;
  font-size: 0.85rem;
  font-weight: 500;
  color: #92400e;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}
[data-theme="dark"] .notif-banner {
  background: linear-gradient(90deg, rgba(254,243,199,0.15), rgba(253,230,138,0.15));
  color: #fbbf24;
}
.notif-banner:hover { background: linear-gradient(90deg, #fde68a, #fcd34d); }

/* CTA button */
.cta-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  padding: 18px 24px;
  margin-top: 28px;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 60%, #1e40af 100%);
  color: #fff;
  text-align: center;
  text-decoration: none;
  border-radius: 16px;
  font-size: 1.05rem;
  font-weight: 700;
  letter-spacing: 0.3px;
  box-shadow: 0 4px 20px rgba(37, 99, 235, 0.35), 0 2px 4px rgba(0,0,0,0.08);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  animation: ctaPulse 3s ease-in-out infinite;
}
@keyframes ctaPulse {
  0%, 100% { box-shadow: 0 4px 20px rgba(37, 99, 235, 0.35); }
  50% { box-shadow: 0 4px 28px rgba(37, 99, 235, 0.5); }
}
.cta-btn::before {
  content: '';
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: ctaShine 3s ease-in-out infinite;
}
@keyframes ctaShine {
  0% { left: -100%; }
  50%, 100% { left: 100%; }
}
.cta-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 28px rgba(37, 99, 235, 0.5), 0 4px 8px rgba(0,0,0,0.1);
}
.cta-btn:active {
  transform: translateY(-1px);
  box-shadow: 0 2px 12px rgba(37, 99, 235, 0.35);
}
.cta-btn .cta-label {
  font-size: 1.05rem;
  font-weight: 700;
  position: relative;
}
.cta-btn .cta-click {
  font-size: 0.78rem;
  font-weight: 600;
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 20px;
  letter-spacing: 1.5px;
  position: relative;
  backdrop-filter: blur(4px);
}

/* Calendar Heatmap */
.calendar-section {
  margin-top: 28px;
}
.calendar-section h3 {
  font-size: 0.9rem;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}
.calendar-weekday {
  text-align: center;
  font-size: 0.68rem;
  font-weight: 600;
  color: var(--text-muted);
  padding: 4px 0;
}
.calendar-day {
  aspect-ratio: 1;
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.68rem;
  font-weight: 500;
  color: var(--text-secondary);
  position: relative;
  transition: all 0.2s;
  overflow: hidden;
}
.calendar-day:hover {
  transform: scale(1.15);
  z-index: 1;
}
.calendar-day.empty { background: transparent; }
.calendar-day.future { background: var(--bg-secondary); color: var(--text-muted); }
.calendar-day.level-0 { background: var(--bg-tertiary); }
.calendar-day.level-1 { background: #dbeafe; color: #1e40af; }
.calendar-day.level-2 { background: #93c5fd; color: #1e3a8a; }
.calendar-day.level-3 { background: #3b82f6; color: #fff; }
.calendar-day.level-4 {
  background: linear-gradient(135deg, #1d4ed8, #1e40af);
  color: #fff;
  border: 1.5px solid #fbbf24;
  box-shadow: 0 0 6px rgba(251,191,36,0.5), inset 0 0 4px rgba(251,191,36,0.15);
  animation: goldShimmer 2s ease-in-out infinite;
}
@keyframes goldShimmer {
  0%, 100% { box-shadow: 0 0 6px rgba(251,191,36,0.4), inset 0 0 4px rgba(251,191,36,0.1); }
  50% { box-shadow: 0 0 12px rgba(251,191,36,0.7), inset 0 0 6px rgba(251,191,36,0.25); }
}
[data-theme="dark"] .calendar-day.level-1 { background: rgba(59,130,246,0.2); color: #93c5fd; }
[data-theme="dark"] .calendar-day.level-2 { background: rgba(59,130,246,0.35); color: #bfdbfe; }
[data-theme="dark"] .calendar-day.level-3 { background: rgba(59,130,246,0.55); color: #fff; }
[data-theme="dark"] .calendar-day.level-4 {
  background: rgba(59,130,246,0.8);
  color: #fff;
  border: 1.5px solid #f59e0b;
  box-shadow: 0 0 6px rgba(245,158,11,0.5), inset 0 0 4px rgba(245,158,11,0.15);
  animation: goldShimmer 2s ease-in-out infinite;
}
.calendar-day.today {
  outline: 2px solid var(--accent);
  outline-offset: 1px;
}
.calendar-day.level-4.today {
  outline: none;
}
.calendar-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
  margin-top: 10px;
  font-size: 0.68rem;
  color: var(--text-muted);
}
.calendar-legend-box {
  width: 14px;
  height: 14px;
  border-radius: 3px;
}
.calendar-month-label {
  text-align: center;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
}
.calendar-nav {
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  color: var(--text-secondary);
  padding: 4px 10px;
  transition: all 0.2s;
}
.calendar-nav:hover {
  background: var(--accent-bg);
  color: var(--accent);
  border-color: var(--accent);
}

/* Badge Section */
.badge-section {
  margin-top: 28px;
}
.badge-section h3 {
  font-size: 0.9rem;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
}
.badge-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.badge-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: 14px;
  padding: 14px 8px;
  text-align: center;
  transition: all 0.3s;
  position: relative;
}
.badge-card.locked {
  opacity: 0.45;
  filter: grayscale(0.8);
}
.badge-card.locked .badge-icon {
  font-size: 1.6rem;
  filter: grayscale(1);
}
.badge-card.locked::after {
  content: 'ğŸ”’';
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 0.65rem;
}
.badge-card.unlocked {
  border-color: #f59e0b;
  background: linear-gradient(145deg, var(--bg-secondary), rgba(245,158,11,0.08));
  animation: badgeGlow 3s ease-in-out infinite;
}
[data-theme="dark"] .badge-card.unlocked {
  border-color: rgba(245,158,11,0.5);
  background: linear-gradient(145deg, var(--bg-secondary), rgba(245,158,11,0.1));
}
@keyframes badgeGlow {
  0%, 100% { box-shadow: 0 0 0 rgba(245,158,11,0); }
  50% { box-shadow: 0 0 12px rgba(245,158,11,0.15); }
}
.badge-icon {
  font-size: 1.8rem;
  display: block;
  margin-bottom: 6px;
  line-height: 1;
}
.badge-name {
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 3px;
}
.badge-desc {
  font-size: 0.62rem;
  color: var(--text-muted);
  line-height: 1.3;
}
.badge-date {
  font-size: 0.58rem;
  color: var(--accent);
  margin-top: 4px;
  font-weight: 500;
}
.badge-category-label {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  margin: 18px 0 10px;
  padding-left: 4px;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.badge-category-label:first-child {
  margin-top: 0;
}

/* Badge Popup */
.badge-popup-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--modal-overlay);
  backdrop-filter: blur(6px);
  z-index: 300;
  justify-content: center;
  align-items: center;
}
.badge-popup-overlay.active {
  display: flex;
  animation: overlayFadeIn 0.3s ease;
}
.badge-popup-content {
  background: var(--bg-primary);
  border-radius: 24px;
  padding: 40px 32px;
  text-align: center;
  max-width: 320px;
  width: 90%;
  animation: badgePopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border: 2px solid #f59e0b;
  box-shadow: 0 0 40px rgba(245,158,11,0.2);
}
@keyframes badgePopIn {
  0% { opacity: 0; transform: scale(0.5) rotate(-10deg); }
  100% { opacity: 1; transform: scale(1) rotate(0deg); }
}
.badge-popup-icon {
  font-size: 4rem;
  display: block;
  margin-bottom: 16px;
  animation: badgePopBounce 1s ease-in-out infinite;
}
@keyframes badgePopBounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}
.badge-popup-title {
  font-size: 1.2rem;
  font-weight: 800;
  color: #f59e0b;
  margin-bottom: 6px;
}
.badge-popup-name {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}
.badge-popup-desc {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.5;
}
.badge-popup-close {
  padding: 12px 32px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: all 0.3s;
}
.badge-popup-close:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245,158,11,0.4);
}

/* Badge Detail Modal */
.badge-detail-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--modal-overlay);
  backdrop-filter: blur(6px);
  z-index: 250;
  justify-content: center;
  align-items: center;
}
.badge-detail-overlay.active {
  display: flex;
  animation: overlayFadeIn 0.3s ease;
}
.badge-detail-content {
  background: var(--bg-primary);
  border-radius: 24px;
  padding: 40px 32px 32px;
  text-align: center;
  max-width: 320px;
  width: 90%;
  position: relative;
  border: 2px solid var(--border);
  box-shadow: var(--shadow-lg);
  animation: badgeDetailIn 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.badge-detail-content.unlocked {
  border-color: #f59e0b;
  box-shadow: 0 0 40px rgba(245,158,11,0.2);
}
@keyframes badgeDetailIn {
  0% { opacity: 0; transform: scale(0.3) rotate(-360deg); }
  60% { transform: scale(1.05) rotate(10deg); }
  80% { transform: scale(0.98) rotate(-3deg); }
  100% { opacity: 1; transform: scale(1) rotate(0deg); }
}
.badge-detail-close {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  line-height: 1;
}
.badge-detail-close:hover {
  background: var(--bg-tertiary);
  transform: scale(1.1);
}
.badge-detail-icon {
  font-size: 5rem;
  display: block;
  margin-bottom: 16px;
  line-height: 1;
}
.badge-detail-content.unlocked .badge-detail-icon {
  animation: badgeDetailSpin 1s ease-out;
}
@keyframes badgeDetailSpin {
  0% { transform: rotateY(0deg) scale(0.5); opacity: 0; }
  50% { transform: rotateY(540deg) scale(1.2); opacity: 1; }
  100% { transform: rotateY(720deg) scale(1); }
}
.badge-detail-name {
  font-size: 1.2rem;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 6px;
}
.badge-detail-desc {
  font-size: 0.88rem;
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: 8px;
}
.badge-detail-status {
  font-size: 0.82rem;
  font-weight: 700;
  padding: 6px 16px;
  border-radius: 20px;
  display: inline-block;
  margin-top: 8px;
}
.badge-detail-status.earned {
  background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(251,191,36,0.2));
  color: #f59e0b;
  border: 1px solid rgba(245,158,11,0.3);
}
.badge-detail-status.locked {
  background: var(--bg-tertiary);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

/* Guide */
.guide-section {
  margin-top: 24px;
  background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
  border-radius: 16px;
  border: 1px solid var(--border);
  overflow: hidden;
}
.guide-toggle {
  width: 100%;
  padding: 14px 18px;
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: 'Inter', sans-serif;
  font-size: 0.88rem;
  font-weight: 700;
  color: var(--text-primary);
}
.guide-toggle .arrow {
  font-size: 0.75rem;
  color: var(--text-muted);
  transition: transform 0.3s;
}
.guide-toggle.open .arrow { transform: rotate(180deg); }
.guide-body {
  display: none;
  padding: 0 18px 18px;
}
.guide-body.open {
  display: block;
  animation: tabFadeIn 0.3s ease;
}
.guide-step {
  display: flex;
  gap: 12px;
  margin-bottom: 14px;
  align-items: flex-start;
}
.guide-step:last-child { margin-bottom: 0; }
.guide-num {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-size: 0.75rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.guide-text {
  font-size: 0.82rem;
  color: var(--text-secondary);
  line-height: 1.6;
}
.guide-text strong { color: var(--text-primary); }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* Date Navigation */
.date-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 16px;
}
.date-nav-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  background: var(--bg-secondary);
  cursor: pointer;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
}
.date-nav-btn:hover:not(:disabled) {
  background: var(--accent-bg);
  border-color: var(--accent);
  color: var(--accent);
}
.date-nav-btn:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}
.date-nav-label {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-primary);
  min-width: 140px;
  text-align: center;
}
.go-today-btn {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--accent);
  background: var(--accent-bg);
  color: var(--accent);
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
}
.go-today-btn:hover {
  background: var(--accent);
  color: #fff;
}
.past-date-notice {
  background: linear-gradient(90deg, #fef3c7, #fde68a);
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 500;
  color: #92400e;
  text-align: center;
  margin-bottom: 14px;
}
[data-theme="dark"] .past-date-notice {
  background: linear-gradient(90deg, rgba(254,243,199,0.12), rgba(253,230,138,0.12));
  color: #fbbf24;
}

/* Past Complete Prompt */
.past-prompt-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--modal-overlay);
  backdrop-filter: blur(6px);
  z-index: 300;
  justify-content: center;
  align-items: center;
}
.past-prompt-overlay.active {
  display: flex;
  animation: overlayFadeIn 0.3s ease;
}
.past-prompt-content {
  background: var(--bg-primary);
  border-radius: 24px;
  padding: 36px 28px 28px;
  text-align: center;
  max-width: 300px;
  width: 85%;
  animation: badgePopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border: 1.5px solid var(--accent-border);
  box-shadow: var(--shadow-lg);
}
.past-prompt-icon {
  font-size: 2.5rem;
  display: block;
  margin-bottom: 12px;
}
.past-prompt-text {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  line-height: 1.5;
}
.past-prompt-yes {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
.past-prompt-yes:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}

.savings-track {
  margin-top: 16px;
  position: relative;
}
.savings-track-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.7rem;
  color: rgba(255,255,255,0.6);
  margin-bottom: 6px;
  font-weight: 500;
}
.savings-track-amount {
  color: rgba(255,255,255,0.95);
  font-weight: 700;
}
.savings-track-bar {
  position: relative;
  height: 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  overflow: visible;
}
.savings-track-fill {
  height: 100%;
  background: linear-gradient(90deg, #f59e0b, #fbbf24);
  border-radius: 4px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  width: 0%;
}
.savings-track-runner {
  position: absolute;
  top: -14px;
  font-size: 1.1rem;
  transform: translateX(-50%);
  transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  animation: coinSpin 1s ease-in-out infinite;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
  left: 0%;
}
@keyframes coinSpin {
  0% { transform: translateX(-50%) translateY(0) rotateY(0deg); }
  50% { transform: translateX(-50%) translateY(-4px) rotateY(180deg); }
  100% { transform: translateX(-50%) translateY(0) rotateY(360deg); }
}
.calendar-savings-summary {
  text-align: center;
  margin-top: 12px;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-secondary);
  padding: 10px;
  background: var(--bg-secondary);
  border-radius: 10px;
  border: 1px solid var(--border-light);
}
.calendar-savings-summary span {
  color: #f59e0b;
  font-weight: 700;
}
.calendar-day.level-4 .day-stamp {
  font-size: 0.48rem;
  line-height: 1;
  font-weight: 800;
  color: #fbbf24;
  border: 1.5px solid #fbbf24;
  border-radius: 3px;
  padding: 1.5px 3px;
  margin-top: 2px;
  letter-spacing: -0.2px;
  transform: rotate(-8deg);
  opacity: 0.9;
  text-shadow: 0 0 2px rgba(0,0,0,0.3);
  animation: stampIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes stampIn {
  0% { transform: rotate(-8deg) scale(2); opacity: 0; }
  100% { transform: rotate(-8deg) scale(1); opacity: 0.9; }
}

/* Responsive */
@media (min-width: 480px) {
  body { padding: 0; }
}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="header-top">
      <div class="header-info">
        <h1>MEDITIAL ì˜ì–‘ì œ ì²´í¬</h1>
        <div class="date" id="headerDate"></div>
      </div>
      <button class="dark-toggle" id="darkToggle" onclick="toggleDarkMode()" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">
        <span id="darkIcon">ğŸŒ™</span>
      </button>
    </div>
    <div class="header-bottom">
      <div class="header-progress" id="headerProgress"></div>
      <span id="streakBadge"></span>
    </div>
    <div id="savingsTrack"></div>
  </header>

  <div class="notif-banner" id="notifBanner" onclick="requestNotifPermission()">
    ì•Œë¦¼ì„ í—ˆìš©í•˜ë©´ ë³µìš© ì‹œê°„ì— ì•Œë ¤ë“œë ¤ìš”. ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”.
  </div>

  <div class="tab-content active" id="today">
    <div id="dateNav"></div>
    <div id="todayList"></div>
    <a href="https://meditial.co.kr/" target="_blank" class="cta-btn"><span class="cta-label">ë‹¤ ë“œì…¨ë‚˜ìš”?</span><span class="cta-click">Click!</span></a>
    <div class="guide-section">
      <button class="guide-toggle" onclick="toggleGuide(this)">
        <span>ì‚¬ìš©ë²• ì•ˆë‚´</span>
        <span class="arrow">â–¼</span>
      </button>
      <div class="guide-body" id="guideBody">
        <div class="guide-step">
          <div class="guide-num">1</div>
          <div class="guide-text"><strong>ê´€ë¦¬</strong> íƒ­ì—ì„œ <strong>+ ì˜ì–‘ì œ ì¶”ê°€</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ë‚´ê°€ ë¨¹ëŠ” ì˜ì–‘ì œë¥¼ ë“±ë¡í•´ìš”.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">2</div>
          <div class="guide-text"><strong>ì˜¤ëŠ˜</strong> íƒ­ì—ì„œ ì˜ì–‘ì œë¥¼ ë¨¹ì„ ë•Œë§ˆë‹¤<br>ë™ê·¸ë€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²´í¬í•´ìš”.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">3</div>
          <div class="guide-text"><strong>í†µê³„</strong> íƒ­ì—ì„œ ë‚´ ë³µìš© ê¸°ë¡ê³¼<br>ìº˜ë¦°ë”ë¥¼ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">4</div>
          <div class="guide-text">ë³µìš© ì²´í¬ë¥¼ í•˜ë©´ ì¬ê³ ê°€ <strong>ìë™ìœ¼ë¡œ ê°ì†Œ</strong>í•´ìš”.<br>ì¬ê³ ê°€ 3ì¼ë¶„ ì´í•˜ê°€ ë˜ë©´ <strong>ë¹¨ê°„ìƒ‰</strong>ìœ¼ë¡œ í‘œì‹œë¼ìš”.</div>
        </div>
        <div class="guide-step">
          <div class="guide-num">5</div>
          <div class="guide-text"><strong>ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ê¸°</strong><br>
            ì•„ì´í°: ì‚¬íŒŒë¦¬ í•˜ë‹¨ <strong>ê³µìœ </strong> â†’ <strong>í™ˆ í™”ë©´ì— ì¶”ê°€</strong><br>
            ì•ˆë“œë¡œì´ë“œ: í¬ë¡¬ ìƒë‹¨ <strong>ë©”ë‰´</strong> â†’ <strong>í™ˆ í™”ë©´ì— ì¶”ê°€</strong></div>
        </div>
        <div class="guide-step">
          <div class="guide-num">6</div>
          <div class="guide-text"><strong>ë‹¤í¬ëª¨ë“œ / ë¼ì´íŠ¸ëª¨ë“œ</strong><br>
            ìƒë‹¨ ì˜¤ë¥¸ìª½ <strong>ğŸŒ™/â˜€ï¸ ë²„íŠ¼</strong>ì„ ëˆŒëŸ¬<br>ë‹¤í¬ëª¨ë“œì™€ ë¼ì´íŠ¸ëª¨ë“œë¥¼ ì „í™˜í•  ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="stats">
    <div id="savingsHero"></div>
    <div class="stat-period">
      <button class="period-btn active" data-days="7">ìµœê·¼ 7ì¼</button>
      <button class="period-btn" data-days="30">ìµœê·¼ 30ì¼</button>
    </div>
    <div class="stat-summary" id="statSummary"></div>
    <div class="chart-section">
      <h3>ì˜ì–‘ì œë³„ ë³µìš©ë¥ </h3>
      <div id="chartBars"></div>
    </div>
    <div class="calendar-section">
      <h3>ë³µìš© ìº˜ë¦°ë”</h3>
      <div id="calendarHeatmap"></div>
    </div>
    <div id="badgeSection"></div>
  </div>

  <div class="tab-content" id="manage">
    <button class="add-btn" onclick="openModal()">+ ì˜ì–‘ì œ ì¶”ê°€</button>
    <div id="manageList"></div>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <button class="nav-item active" data-tab="today">
    <span class="nav-icon">ğŸ’Š</span>
    <span class="nav-label">ì˜¤ëŠ˜</span>
  </button>
  <button class="nav-item" data-tab="stats">
    <span class="nav-icon">ğŸ“Š</span>
    <span class="nav-label">í†µê³„</span>
  </button>
  <button class="nav-item" data-tab="manage">
    <span class="nav-icon">âš™ï¸</span>
    <span class="nav-label">ê´€ë¦¬</span>
  </button>
</nav>

<!-- Badge Popup -->
<div class="badge-popup-overlay" id="badgePopup">
  <div class="badge-popup-content">
    <span class="badge-popup-icon" id="badgePopupIcon"></span>
    <div class="badge-popup-title">ì—…ì  ë‹¬ì„±!</div>
    <div class="badge-popup-name" id="badgePopupName"></div>
    <div class="badge-popup-desc" id="badgePopupDesc"></div>
    <button class="badge-popup-close" onclick="closeBadgePopup()">í™•ì¸</button>
  </div>
</div>

<!-- Badge Detail Modal -->
<div class="badge-detail-overlay" id="badgeDetail">
  <div class="badge-detail-content" id="badgeDetailContent">
    <button class="badge-detail-close" onclick="closeBadgeDetail()">âœ•</button>
    <span class="badge-detail-icon" id="badgeDetailIcon"></span>
    <div class="badge-detail-name" id="badgeDetailName"></div>
    <div class="badge-detail-desc" id="badgeDetailDesc"></div>
    <div class="badge-detail-status" id="badgeDetailStatus"></div>
  </div>
</div>

<!-- Past Complete Prompt -->
<div class="past-prompt-overlay" id="pastPrompt">
  <div class="past-prompt-content">
    <span class="past-prompt-icon">ğŸ’Š</span>
    <div class="past-prompt-text">ì˜¤ëŠ˜ë„ ê¼­ ë“œì‹¤ ê±°ì£ ?</div>
    <button class="past-prompt-yes" onclick="closePastPromptAndGoToday()">YES</button>
  </div>
</div>

<!-- Confetti container -->
<div class="confetti-container" id="confettiContainer"></div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">ì˜ì–‘ì œ ì¶”ê°€</h2>
    <input type="hidden" id="editId">
    <div class="form-group">
      <label>ì´ë¦„</label>
      <select id="inputName" onchange="toggleCustomName()">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="ë¸”ëŸ¬ë“œì‹¸ì´í´">ë¸”ëŸ¬ë“œì‹¸ì´í´</option>
        <option value="í—¬ë¦¬ì»·">í—¬ë¦¬ì»·</option>
        <option value="íŒí† ì˜¤í‹´">íŒí† ì˜¤í‹´</option>
        <option value="ê¸€ë£¨íƒ€ì¹˜ì˜¨">ê¸€ë£¨íƒ€ì¹˜ì˜¨</option>
        <option value="ë©œë¼í† ë‹Œ">ë©œë¼í† ë‹Œ</option>
        <option value="í˜ˆë‹¹ì»·">í˜ˆë‹¹ì»·</option>
        <option value="í™œì„±ì—½ì‚°">í™œì„±ì—½ì‚°</option>
        <option value="ìƒì–´ì—°ê³¨í™˜">ìƒì–´ì—°ê³¨í™˜</option>
        <option value="__custom__">ì§ì ‘ ì…ë ¥</option>
      </select>
      <input type="text" id="inputCustomName" placeholder="ì˜ì–‘ì œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="display:none; margin-top:8px;">
    </div>
    <div class="form-group">
      <label>ë³µìš© ì‹œê°„</label>
      <input type="time" id="inputTime" value="09:00">
    </div>
    <div class="form-group">
      <label>ë³µìš©ëŸ‰</label>
      <input type="text" id="inputDose" placeholder="ì˜ˆ: 1ì •">
    </div>
    <div class="form-group">
      <label>ì¬ê³  ìˆ˜ëŸ‰ (ì¼ë¶„)</label>
      <input type="number" id="inputStock" min="0" value="30">
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveSupplement()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
// --- Supplement Colors ---
const SUPP_COLORS = {
  'ë¸”ëŸ¬ë“œì‹¸ì´í´': { bg: '#fef2f2', border: '#fca5a5', bar: '#ef4444', text: '#dc2626' },
  'í—¬ë¦¬ì»·':       { bg: '#f0fdf4', border: '#86efac', bar: '#22c55e', text: '#16a34a' },
  'íŒí† ì˜¤í‹´':     { bg: '#eff6ff', border: '#93c5fd', bar: '#3b82f6', text: '#2563eb' },
  'ê¸€ë£¨íƒ€ì¹˜ì˜¨':   { bg: '#fdf2f8', border: '#f9a8d4', bar: '#ec4899', text: '#db2777' },
  'ë©œë¼í† ë‹Œ':     { bg: '#f5f3ff', border: '#c4b5fd', bar: '#8b5cf6', text: '#7c3aed' },
  'í˜ˆë‹¹ì»·':       { bg: '#f7fee7', border: '#bef264', bar: '#84cc16', text: '#65a30d' },
  'í™œì„±ì—½ì‚°':     { bg: '#f3f0ff', border: '#d8b4fe', bar: '#a78bfa', text: '#8b5cf6' },
  'ìƒì–´ì—°ê³¨í™˜':   { bg: '#faf5ff', border: '#e9d5ff', bar: '#c084fc', text: '#a855f7' },
};
const SUPP_COLORS_DARK = {
  'ë¸”ëŸ¬ë“œì‹¸ì´í´': { bg: 'rgba(239,68,68,0.1)', border: 'rgba(252,165,165,0.3)', bar: '#f87171', text: '#fca5a5' },
  'í—¬ë¦¬ì»·':       { bg: 'rgba(34,197,94,0.1)', border: 'rgba(134,239,172,0.3)', bar: '#4ade80', text: '#86efac' },
  'íŒí† ì˜¤í‹´':     { bg: 'rgba(59,130,246,0.1)', border: 'rgba(147,197,253,0.3)', bar: '#60a5fa', text: '#93c5fd' },
  'ê¸€ë£¨íƒ€ì¹˜ì˜¨':   { bg: 'rgba(236,72,153,0.1)', border: 'rgba(249,168,212,0.3)', bar: '#f472b6', text: '#f9a8d4' },
  'ë©œë¼í† ë‹Œ':     { bg: 'rgba(139,92,246,0.1)', border: 'rgba(196,181,253,0.3)', bar: '#a78bfa', text: '#c4b5fd' },
  'í˜ˆë‹¹ì»·':       { bg: 'rgba(132,204,22,0.1)', border: 'rgba(190,242,100,0.3)', bar: '#a3e635', text: '#bef264' },
  'í™œì„±ì—½ì‚°':     { bg: 'rgba(167,139,250,0.1)', border: 'rgba(216,180,254,0.3)', bar: '#c084fc', text: '#d8b4fe' },
  'ìƒì–´ì—°ê³¨í™˜':   { bg: 'rgba(192,132,252,0.1)', border: 'rgba(233,213,255,0.3)', bar: '#d8b4fe', text: '#e9d5ff' },
};
function getSuppColor(name) {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const palette = isDark ? SUPP_COLORS_DARK : SUPP_COLORS;
  return palette[name] || (isDark
    ? { bg: 'rgba(148,163,184,0.1)', border: 'rgba(148,163,184,0.2)', bar: '#94a3b8', text: '#cbd5e1' }
    : { bg: '#f8fafc', border: '#e2e8f0', bar: '#94a3b8', text: '#64748b' });
}

// --- Dark Mode ---
function initDarkMode() {
  const saved = localStorage.getItem('darkMode');
  if (saved === 'true' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('darkIcon').textContent = 'â˜€ï¸';
  }
}
function toggleDarkMode() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  if (isDark) {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('darkIcon').textContent = 'ğŸŒ™';
    localStorage.setItem('darkMode', 'false');
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('darkIcon').textContent = 'â˜€ï¸';
    localStorage.setItem('darkMode', 'true');
  }
  renderToday();
  if (document.getElementById('stats').classList.contains('active')) renderStats();
  if (document.getElementById('manage').classList.contains('active')) renderManage();
}
initDarkMode();

// --- Data ---
const STORAGE_KEY = 'supp_data';
const RECORDS_KEY = 'supp_records';

function loadSupplements() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}
function saveSupplements(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function loadRecords() {
  return JSON.parse(localStorage.getItem(RECORDS_KEY) || '{}');
}
function saveRecords(rec) {
  localStorage.setItem(RECORDS_KEY, JSON.stringify(rec));
}

function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function formatDate(d) {
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
}

// --- Selected Date ---
let selectedDate = new Date();

function selectedDateKey() {
  const d = selectedDate;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function isSelectedToday() {
  return selectedDateKey() === todayKey();
}

function changeSelectedDate(delta) {
  const next = new Date(selectedDate);
  next.setDate(next.getDate() + delta);
  const today = new Date();
  today.setHours(0,0,0,0);
  next.setHours(0,0,0,0);
  if (next > today) return;
  const limit = new Date(today);
  limit.setDate(limit.getDate() - 2);
  if (next < limit) return;
  selectedDate = next;
  renderDateNav();
  renderToday();
}

function goToToday() {
  selectedDate = new Date();
  renderDateNav();
  renderToday();
}

function showPastCompletePrompt() {
  document.getElementById('pastPrompt').classList.add('active');
}

function closePastPromptAndGoToday() {
  document.getElementById('pastPrompt').classList.remove('active');
  goToToday();
}

function renderDateNav() {
  const container = document.getElementById('dateNav');
  const isTodaySelected = isSelectedToday();
  const tomorrow = new Date(selectedDate);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const today = new Date();
  today.setHours(0,0,0,0);
  tomorrow.setHours(0,0,0,0);
  const isFutureDisabled = tomorrow > today;
  const prevDay = new Date(selectedDate);
  prevDay.setDate(prevDay.getDate() - 1);
  prevDay.setHours(0,0,0,0);
  const limit = new Date(today);
  limit.setDate(limit.getDate() - 2);
  const isPastDisabled = prevDay < limit;

  container.innerHTML = `
    <div class="date-nav">
      <button class="date-nav-btn" onclick="changeSelectedDate(-1)" ${isPastDisabled ? 'disabled' : ''}>â—€</button>
      <span class="date-nav-label">${formatDate(selectedDate)}</span>
      <button class="date-nav-btn" onclick="changeSelectedDate(1)" ${isFutureDisabled ? 'disabled' : ''}>â–¶</button>
      ${!isTodaySelected ? '<button class="go-today-btn" onclick="goToToday()">ì˜¤ëŠ˜ë¡œ</button>' : ''}
    </div>
    ${!isTodaySelected ? '<div class="past-date-notice">ê³¼ê±° ë‚ ì§œì˜ ë³µìš© ê¸°ë¡ì„ í™•ì¸/ìˆ˜ì •í•©ë‹ˆë‹¤</div>' : ''}
  `;
}

// --- Header ---
document.getElementById('headerDate').textContent = formatDate(new Date());

// --- Streak Badge ---
function renderStreak() {
  const streak = calculateStreak();
  document.getElementById('streakBadge').innerHTML = streak > 0
    ? `<div class="streak-badge"><span class="streak-fire">ğŸ”¥</span> ${streak}ì¼ ì—°ì† ë³µìš© ì¤‘!</div>`
    : '';
}

// --- Header Progress Ring ---
function renderHeaderProgress() {
  const list = loadSupplements();
  const container = document.getElementById('headerProgress');
  if (list.length === 0) {
    container.innerHTML = '';
    return;
  }

  const records = loadRecords();
  const key = todayKey();
  const todayRec = records[key] || [];
  const taken = list.filter(s => todayRec.includes(s.id)).length;
  const total = list.length;
  const pct = Math.round(taken / total * 100);

  const circumference = 2 * Math.PI * 22;
  const offset = circumference - (pct / 100) * circumference;

  container.innerHTML = `
    <div class="progress-ring-wrap">
      <svg width="56" height="56" viewBox="0 0 56 56">
        <circle class="progress-ring-bg" cx="28" cy="28" r="22"/>
        <circle class="progress-ring-bar" cx="28" cy="28" r="22"
          stroke-dasharray="${circumference}"
          stroke-dashoffset="${offset}"/>
      </svg>
      <div class="progress-ring-text">${pct}%</div>
    </div>
    <div class="progress-detail">
      <strong>${taken}/${total}</strong> ë³µìš© ì™„ë£Œ<br>
      ${taken === total ? 'ì˜¤ëŠ˜ ì™„ë²½í•´ìš”!' : `${total - taken}ê°œ ë‚¨ì•˜ì–´ìš”`}
    </div>
  `;
}

// --- Savings Calc & Track (Piggy Bank Runner) ---
function calcSavings() {
  const list = loadSupplements();
  if (list.length === 0) return 0;
  const now = new Date();
  const records = loadRecords();
  let perfectDays = 0;
  for (let i = 29; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const dayRec = records[key] || [];
    if (list.every(s => dayRec.includes(s.id))) perfectDays++;
  }
  return perfectDays * 167;
}

function renderSavingsTrack() {
  const container = document.getElementById('savingsTrack');
  const list = loadSupplements();
  if (list.length === 0) {
    container.innerHTML = '';
    return;
  }
  const savings = calcSavings();
  const goal = 5000;
  const pct = Math.min(Math.round(savings / goal * 100), 100);
  container.innerHTML = `
    <div class="savings-track">
      <div class="savings-track-labels">
        <span class="savings-track-amount">ğŸª™ ${savings.toLocaleString()}ì›</span>
        <span>${goal.toLocaleString()}ì›</span>
      </div>
      <div class="savings-track-bar">
        <div class="savings-track-fill" style="width:${pct}%"></div>
        <div class="savings-track-runner" style="left:${pct}%">ğŸª™</div>
      </div>
    </div>
  `;
}

// --- Bottom Navigation ---
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    item.classList.add('active');
    document.getElementById(item.dataset.tab).classList.add('active');
    if (item.dataset.tab === 'stats') renderStats();
    if (item.dataset.tab === 'manage') renderManage();
    if (item.dataset.tab === 'today') { selectedDate = new Date(); renderToday(); }
  });
});

// --- Confetti Effect ---
function fireConfetti(x, y) {
  const container = document.getElementById('confettiContainer');
  const colors = ['#2563eb','#22c55e','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4'];
  for (let i = 0; i < 20; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
    piece.style.top = (y - 10) + 'px';
    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
    piece.style.width = (6 + Math.random() * 6) + 'px';
    piece.style.height = (6 + Math.random() * 6) + 'px';
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    piece.style.animationDuration = (0.8 + Math.random() * 0.8) + 's';
    piece.style.animationDelay = (Math.random() * 0.2) + 's';
    const angle = (Math.random() - 0.5) * 120;
    piece.style.setProperty('--spread', angle + 'deg');
    container.appendChild(piece);
    setTimeout(() => piece.remove(), 1600);
  }
}

function fireBigConfetti() {
  const container = document.getElementById('confettiContainer');
  const colors = ['#2563eb','#22c55e','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
  for (let i = 0; i < 50; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = (Math.random() * window.innerWidth) + 'px';
    piece.style.top = (-20 - Math.random() * 40) + 'px';
    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
    piece.style.width = (8 + Math.random() * 8) + 'px';
    piece.style.height = (8 + Math.random() * 8) + 'px';
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    piece.style.animationDuration = (1 + Math.random() * 1.5) + 's';
    piece.style.animationDelay = (Math.random() * 0.5) + 's';
    container.appendChild(piece);
    setTimeout(() => piece.remove(), 2500);
  }
}

// --- Haptic Feedback ---
function vibrate(pattern) {
  if (navigator.vibrate) {
    navigator.vibrate(pattern || 30);
  }
}

// --- Care Messages ---
const CARE_DONE = [
  'ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”.',
  'ì˜¤ëŠ˜ì˜ í•  ì¼, ê°€ì¥ ì¤‘ìš”í•œ ê±´ ëë‚¬ì–´ìš”.',
  'ëª¸ì´ ë¶„ëª…íˆ ê¸°ì–µí•  ê±°ì˜ˆìš”.',
  'ì‘ì€ ìŠµê´€ì´ ì˜¤ëŠ˜ë„ ì§€ì¼œì¡Œì–´ìš”.',
  'ì˜¤ëŠ˜ í•˜ë£¨, ë‚˜ë¥¼ ì±™ê¸´ ê¸°ë¡ì´ í•˜ë‚˜ ë‚¨ì•˜ì–´ìš”.',
  'ì˜¤ëŠ˜ë„ ìŠ¤ìŠ¤ë¡œì™€ì˜ ì•½ì†ì„ ì§€ì¼°ë„¤ìš”.',
  'ì´ê²Œ ìŒ“ì´ë©´, ë‹¬ë¼ì§‘ë‹ˆë‹¤.',
  'ì˜¤ëŠ˜ì˜ ì„ íƒì´ ë‚´ì¼ì˜ ì»¨ë””ì…˜ì„ ë§Œë“­ë‹ˆë‹¤.',
  'ì‰¬ì›Œ ë³´ì´ì§€ë§Œ, ì•„ë¬´ë‚˜ ëª» í•˜ëŠ” ì¼.',
  'ê³„ì† ê°€ê³  ìˆë‹¤ëŠ” ê²Œ ì¤‘ìš”í•´ìš”.',
  'ì˜¤ëŠ˜ë„ ì• ì“°ì…¨ì£ . ì¶©ë¶„í•´ìš”.',
  'ì˜¤ëŠ˜ í•˜ë£¨, ì´ ì •ë„ë©´ ì˜í•œ ê±°ì˜ˆìš”.',
  'ë‚˜ë¥¼ ì±™ê¸°ëŠ” ì‚¬ëŒì€ ëŠ˜ ë°”ìœ ì‚¬ëŒì…ë‹ˆë‹¤.',
  'ì™„ë²½í•˜ì§€ ì•Šì•„ë„, ê³„ì†í•˜ëŠ” ê²Œ ë©‹ì ¸ìš”.',
  'ì˜¤ëŠ˜ì€ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì ìˆ˜ ì£¼ì…”ë„ ë¼ìš”.',
  'ì˜¤ëŠ˜ì˜ ê±´ê°• ë£¨í‹´, ê¹”ë”í•˜ê²Œ ì™„ë£Œ.',
  'ë©”ë””ì…œì´ í•¨ê»˜í•œ ì˜¤ëŠ˜ì˜ ê¸°ë¡.',
  'ì˜¤ëŠ˜ì˜ ì²´í¬ í•˜ë‚˜ê°€ ë‚´ì¼ì„ ë°”ê¿‰ë‹ˆë‹¤.',
  'ê±´ê°•ì€ ì´ë ‡ê²Œ ìŒ“ì…ë‹ˆë‹¤.',
  'ì˜¤ëŠ˜ë„ ì¢‹ì€ ì„ íƒì„ í•˜ì…¨ì–´ìš”.',
];
const CARE_NOT_DONE = [
  'ì•„ì§ í•˜ë£¨ëŠ” ë‚¨ì•„ ìˆì–´ìš”.',
  'ì˜¤ëŠ˜ì€ ì•„ì§ ëë‚˜ì§€ ì•Šì•˜ì–´ìš”.',
  'ì§€ê¸ˆ ìƒê°ë‚¬ë‹¤ë©´, ë”± ì¢‹ì€ íƒ€ì´ë°ì´ì—ìš”.',
  'ê´œì°®ì•„ìš”. ì²œì²œíˆ ê°€ë„ ë¼ìš”.',
  'ì˜¤ëŠ˜ í•œ ë²ˆ ë” ê¸°íšŒê°€ ìˆì–´ìš”.',
  'ë°”ìœ ë‚ ì—” ëˆ„êµ¬ë‚˜ ë†“ì¹  ìˆ˜ ìˆì–´ìš”.',
  'ì˜¤ëŠ˜ì´ ìœ ë‚œíˆ ì •ì‹ ì—†ì—ˆì£ ?',
  'ê¹œë¹¡í•´ë„ ê´œì°®ì•„ìš”.',
  'ê±´ê°•ì€ ì™„ë²½í•¨ë³´ë‹¤ ë°©í–¥ì´ì—ìš”.',
  'ì˜¤ëŠ˜ë„ ì• ì“´ í•˜ë£¨ì˜€ì–´ìš”.',
];


function getDailyRandom(arr, seed) {
  const key = todayKey();
  let hash = 0;
  for (let i = 0; i < key.length; i++) hash = ((hash << 5) - hash) + key.charCodeAt(i);
  hash = ((hash << 5) - hash) + seed;
  return arr[Math.abs(hash) % arr.length];
}

// --- Today ---
function renderToday() {
  const list = loadSupplements();
  const container = document.getElementById('todayList');
  renderHeaderProgress();
  renderSavingsTrack();
  renderStreak();
  renderDateNav();

  if (list.length === 0) {
    container.innerHTML = `
      <div class="today-empty">
        <span class="empty-icon">ğŸ’Š</span>
        <div class="empty-title">ì•„ì§ ë“±ë¡ëœ ì˜ì–‘ì œê°€ ì—†ì–´ìš”</div>
        <div class="empty-desc">ê´€ë¦¬ íƒ­ì—ì„œ ì˜ì–‘ì œë¥¼ ì¶”ê°€í•˜ê³ <br>ë§¤ì¼ ë³µìš©ì„ ì²´í¬í•´ë³´ì„¸ìš”!</div>
        <button class="add-btn" onclick="switchToManage()" style="max-width:220px;margin:0 auto">+ ì˜ì–‘ì œ ì¶”ê°€í•˜ê¸°</button>
      </div>`;
    return;
  }

  const records = loadRecords();
  const key = selectedDateKey();
  const todayRec = records[key] || [];

  // Check all done
  const allDone = list.every(s => todayRec.includes(s.id));

  // group by time
  const groups = {};
  list.forEach(s => {
    const t = s.time || '00:00';
    if (!groups[t]) groups[t] = [];
    groups[t].push(s);
  });

  const sortedTimes = Object.keys(groups).sort();
  let html = '';

  // Care message + Recovery (only on real today)
  if (isSelectedToday()) {
    if (allDone) {
      html += `
        <div class="completion-banner">
          <span class="celebrate-icon">ğŸª™</span>
          <div class="celebrate-title">ì˜¤ëŠ˜ì˜ ê±´ê°• ì ë¦½ì™„ë£Œ!!</div>
          <div class="celebrate-desc">${getDailyRandom(CARE_DONE, 1)}</div>
        </div>`;
    } else {
      html += `
        <div class="care-message">
          <span class="care-icon">ğŸ’¬</span>
          <div class="care-text">${getDailyRandom(CARE_NOT_DONE, 2)}</div>
        </div>`;
    }
  } else if (allDone) {
    html += `
      <div class="completion-banner">
        <span class="celebrate-icon">ğŸ‰</span>
        <div class="celebrate-title">ì´ ë‚  ì˜ì–‘ì œ ì™„ë£Œ!</div>
        <div class="celebrate-desc">ëª¨ë“  ì˜ì–‘ì œë¥¼ ë³µìš©í–ˆì–´ìš”!</div>
      </div>`;
  }

  sortedTimes.forEach(time => {
    html += `<div class="time-group">`;
    html += `<div class="time-group-label">${time}</div>`;
    groups[time].forEach(s => {
      const checked = todayRec.includes(s.id);
      const lowStock = s.stock <= 3;
      const clr = getSuppColor(s.name);
      html += `
        <div class="supp-card ${checked ? 'checked' : ''}" data-id="${s.id}" style="border-left: 4px solid ${clr.bar}; ${!checked ? 'background:' + clr.bg : ''}">
          <button class="check-btn" onclick="toggleCheck('${s.id}', event)" style="${!checked ? 'border-color:' + clr.bar : ''}">${checked ? 'âœ“' : ''}</button>
          <div class="info">
            <div class="name" style="${!checked ? 'color:' + clr.text : ''}">${esc(s.name)}</div>
            <div class="detail">${esc(s.dose)}</div>
          </div>
          <div class="stock-badge ${lowStock ? 'low' : ''}" style="${!lowStock ? 'background:' + clr.border + '40; color:' + clr.text : ''}">${s.stock}ì¼ë¶„</div>
        </div>`;
    });
    html += `</div>`;
  });
  container.innerHTML = html;
}

function toggleCheck(id, event) {
  const records = loadRecords();
  const key = selectedDateKey();
  if (!records[key]) records[key] = [];

  const list = loadSupplements();
  const supp = list.find(s => s.id === id);
  if (!supp) return;

  const idx = records[key].indexOf(id);
  const isChecking = idx === -1;

  if (isChecking) {
    records[key].push(id);
    if (supp.stock > 0) supp.stock--;
    saveCheckTime(id);

    // Haptic + confetti
    vibrate(30);
    if (event) {
      const rect = event.target.getBoundingClientRect();
      fireConfetti(rect.left + rect.width / 2, rect.top);
    }

    // Check if all done after this check
    const allDone = list.every(s => s.id === id || records[key].includes(s.id));
    if (allDone) {
      vibrate([50, 50, 100]);
      setTimeout(() => fireBigConfetti(), 300);
    }

    // Past date all done â†’ prompt to go back to today
    if (allDone && !isSelectedToday()) {
      saveRecords(records);
      saveSupplements(list);
      renderToday();
      checkBadges();
      setTimeout(() => {
        showPastCompletePrompt();
      }, 600);
      return;
    }
  } else {
    records[key].splice(idx, 1);
    supp.stock++;
    // Remove check time record
    const ct = loadCheckTimes();
    delete ct[`${key}_${id}`];
    saveCheckTimes(ct);
  }

  saveRecords(records);
  saveSupplements(list);
  renderToday();
  if (isChecking) checkBadges();
  else recheckBadges();
}

function switchToManage() {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.nav-item[data-tab="manage"]').classList.add('active');
  document.getElementById('manage').classList.add('active');
  renderManage();
}

// --- Streak Calculation ---
function calculateStreak() {
  const list = loadSupplements();
  if (list.length === 0) return 0;
  const records = loadRecords();
  let streak = 0;
  const d = new Date();

  // Check today first
  const todayK = todayKey();
  const todayRec = records[todayK] || [];
  const todayDone = list.every(s => todayRec.includes(s.id));

  // If today is not done yet, start checking from yesterday
  if (!todayDone) {
    d.setDate(d.getDate() - 1);
  }

  for (let i = 0; i < 365; i++) {
    const dk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const dayRec = records[dk] || [];
    if (list.every(s => dayRec.includes(s.id))) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

// --- Stats ---
let statDays = 7;
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    statDays = parseInt(btn.dataset.days);
    renderStats();
  });
});

function renderStats() {
  recheckBadges();
  const list = loadSupplements();
  const records = loadRecords();
  const days = statDays;

  renderStreak();

  // Savings hero
  if (list.length > 0) {
    const savings = calcSavings();
    const goal = 5000;
    const savPct = Math.min(Math.round(savings / goal * 100), 100);
    document.getElementById('savingsHero').innerHTML = `
      <div class="savings-hero">
        <div class="savings-hero-icon">ğŸª™</div>
        <div class="savings-hero-amount">${savings.toLocaleString()}ì›</div>
        <div class="savings-hero-label">ì´ ì ë¦½ê¸ˆ</div>
        <div class="savings-hero-bar-wrap">
          <div class="savings-hero-bar">
            <div class="savings-hero-bar-fill" style="width:${savPct}%"></div>
          </div>
          <div class="savings-hero-bar-labels">
            <span>0ì›</span>
            <span>ëª©í‘œ ${goal.toLocaleString()}ì›</span>
          </div>
        </div>
      </div>`;
  } else {
    document.getElementById('savingsHero').innerHTML = '';
  }

  if (list.length === 0) {
    document.getElementById('statSummary').innerHTML = '';
    document.getElementById('chartBars').innerHTML = `
      <div class="stats-empty">
        <span class="empty-icon">ğŸ“Š</span>
        <div class="empty-title">ì•„ì§ í†µê³„ê°€ ì—†ì–´ìš”</div>
        <div class="empty-desc">ì˜ì–‘ì œë¥¼ ë“±ë¡í•˜ê³  ë³µìš©ì„ ì²´í¬í•˜ë©´<br>ì—¬ê¸°ì— í†µê³„ê°€ ë‚˜íƒ€ë‚˜ìš”!</div>
      </div>`;
    document.getElementById('calendarHeatmap').innerHTML = '';
    renderBadges();
    return;
  }

  // Compute per-supplement adherence
  const dateKeys = [];
  for (let i = 0; i < days; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    dateKeys.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
  }

  let totalPossible = 0;
  let totalTaken = 0;
  const perSupp = {};

  list.forEach(s => {
    perSupp[s.id] = { name: s.name, taken: 0, possible: days, color: getSuppColor(s.name) };
    dateKeys.forEach(dk => {
      totalPossible++;
      if (records[dk] && records[dk].includes(s.id)) {
        totalTaken++;
        perSupp[s.id].taken++;
      }
    });
  });

  const overallRate = totalPossible > 0 ? Math.round(totalTaken / totalPossible * 100) : 0;

  let perfectDays = 0;
  dateKeys.forEach(dk => {
    const dayRec = records[dk] || [];
    if (list.every(s => dayRec.includes(s.id))) perfectDays++;
  });

  document.getElementById('statSummary').innerHTML = `
    <div class="stat-box"><div class="value">${overallRate}%</div><div class="label">ì „ì²´ ë³µìš©ë¥ </div></div>
    <div class="stat-box"><div class="value">${perfectDays}ì¼</div><div class="label">ì™„ë²½í•œ ë‚ </div></div>
    <div class="stat-box"><div class="value">${(perfectDays * 167).toLocaleString()}ì›</div><div class="label">ì ë¦½ê¸ˆ</div></div>
  `;

  let barsHtml = '';
  Object.values(perSupp).forEach(ps => {
    const rate = Math.round(ps.taken / ps.possible * 100);
    const clr = ps.color;
    barsHtml += `
      <div class="chart-bar-row">
        <div class="chart-bar-label" style="color:${clr.text}">${esc(ps.name)}</div>
        <div class="chart-bar-track" style="background:${clr.bg}"><div class="chart-bar-fill" style="width:${rate}%; background:linear-gradient(90deg, ${clr.border}, ${clr.bar})"></div></div>
        <div class="chart-bar-value" style="color:${clr.text}">${rate}%</div>
      </div>`;
  });
  document.getElementById('chartBars').innerHTML = barsHtml;

  renderCalendar();
  renderBadges();
}

// --- Manage ---
function renderManage() {
  const list = loadSupplements();
  const container = document.getElementById('manageList');
  if (list.length === 0) {
    container.innerHTML = `
      <div class="manage-empty">
        <span class="empty-icon">âš™ï¸</span>
        <div class="empty-title">ì˜ì–‘ì œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
        <div class="empty-desc">ìœ„ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³µìš© ì¤‘ì¸<br>ì˜ì–‘ì œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.</div>
      </div>`;
    return;
  }
  let html = '';
  list.forEach(s => {
    const lowStock = s.stock <= 3;
    const clr = getSuppColor(s.name);
    html += `
      <div class="manage-card" style="border-left: 4px solid ${clr.bar}; background: ${clr.bg}">
        <div class="manage-card-header">
          <span class="name" style="color:${clr.text}">${esc(s.name)}</span>
          <div class="manage-card-actions">
            <button onclick="openModal('${s.id}')" title="ìˆ˜ì •">âœï¸</button>
            <button class="delete-btn" onclick="deleteSupplement('${s.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="detail-row">${esc(s.time)} Â· ${esc(s.dose)}</div>
        <div class="stock-row">
          <span style="font-size:0.82rem;color:var(--text-muted)">ì¬ê³ :</span>
          <span style="font-size:0.88rem;font-weight:700;color:${lowStock ? 'var(--red)' : clr.text}">${s.stock}ì¼ë¶„</span>
        </div>
      </div>`;
  });
  container.innerHTML = html;
}


function deleteSupplement(id) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const list = loadSupplements().filter(s => s.id !== id);
  saveSupplements(list);
  // Remove deleted supplement from all records
  const records = loadRecords();
  Object.keys(records).forEach(key => {
    records[key] = records[key].filter(rid => rid !== id);
  });
  saveRecords(records);
  renderManage();
  renderToday();
  recheckBadges();
}

// --- Modal ---
function openModal(editId) {
  const overlay = document.getElementById('modalOverlay');
  overlay.classList.add('active');
  if (editId) {
    const s = loadSupplements().find(x => x.id === editId);
    if (!s) return;
    document.getElementById('modalTitle').textContent = 'ì˜ì–‘ì œ ìˆ˜ì •';
    document.getElementById('editId').value = editId;
    const nameSelect = document.getElementById('inputName');
    const customInput = document.getElementById('inputCustomName');
    const isPreset = [...nameSelect.options].some(o => o.value === s.name && o.value !== '__custom__');
    if (isPreset) {
      nameSelect.value = s.name;
      customInput.style.display = 'none';
      customInput.value = '';
    } else {
      nameSelect.value = '__custom__';
      customInput.style.display = 'block';
      customInput.value = s.name;
    }
    document.getElementById('inputTime').value = s.time;
    document.getElementById('inputDose').value = s.dose;
    document.getElementById('inputStock').value = s.stock;
  } else {
    document.getElementById('modalTitle').textContent = 'ì˜ì–‘ì œ ì¶”ê°€';
    document.getElementById('editId').value = '';
    document.getElementById('inputName').value = '';
    document.getElementById('inputCustomName').style.display = 'none';
    document.getElementById('inputCustomName').value = '';
    document.getElementById('inputTime').value = '09:00';
    document.getElementById('inputDose').value = '';
    document.getElementById('inputStock').value = 30;
  }
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});

function toggleCustomName() {
  const sel = document.getElementById('inputName');
  const custom = document.getElementById('inputCustomName');
  if (sel.value === '__custom__') {
    custom.style.display = 'block';
    custom.focus();
  } else {
    custom.style.display = 'none';
    custom.value = '';
  }
}

function saveSupplement() {
  const sel = document.getElementById('inputName').value;
  const name = (sel === '__custom__' ? document.getElementById('inputCustomName').value.trim() : sel.trim());
  const time = document.getElementById('inputTime').value;
  const dose = document.getElementById('inputDose').value.trim();
  const stock = parseInt(document.getElementById('inputStock').value) || 0;
  const editId = document.getElementById('editId').value;

  if (!name) { alert('ì˜ì–‘ì œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
  if (!dose) { alert('ë³µìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

  const list = loadSupplements();

  if (editId) {
    const s = list.find(x => x.id === editId);
    if (s) {
      s.name = name;
      s.time = time;
      s.dose = dose;
      s.stock = stock;
    }
  } else {
    list.push({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
      name, time, dose, stock
    });
  }

  saveSupplements(list);
  closeModal();
  renderManage();
  renderToday();
  checkBadges();
}

// --- Notifications ---
function checkNotifPermission() {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    document.getElementById('notifBanner').style.display = 'block';
  }
}

function requestNotifPermission() {
  if (!('Notification' in window)) return;
  Notification.requestPermission().then(p => {
    document.getElementById('notifBanner').style.display = 'none';
  });
}

function checkAlarms() {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const now = new Date();
  const hm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const list = loadSupplements();
  const records = loadRecords();
  const key = todayKey();
  const todayRec = records[key] || [];

  list.forEach(s => {
    if (s.time === hm && !todayRec.includes(s.id)) {
      const notifKey = `notif_${key}_${s.id}`;
      if (!sessionStorage.getItem(notifKey)) {
        new Notification('ì˜ì–‘ì œ ì•Œë¦¼', {
          body: `${s.name} (${s.dose}) ë³µìš©í•  ì‹œê°„ì´ì—ìš”!`,
          icon: 'icon.png'
        });
        sessionStorage.setItem(notifKey, '1');
      }
    }
  });
}

function checkEveningReminder() {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const now = new Date();
  if (now.getHours() !== 21) return;

  const list = loadSupplements();
  if (list.length === 0) return;

  const records = loadRecords();
  const key = todayKey();
  const todayRec = records[key] || [];
  const missed = list.filter(s => !todayRec.includes(s.id));

  if (missed.length === 0) return;

  const notifKey = `notif_evening_${key}`;
  if (sessionStorage.getItem(notifKey)) return;

  const names = missed.map(s => s.name).join(', ');
  new Notification('ë¯¸ë³µìš© ì˜ì–‘ì œ ì•Œë¦¼', {
    body: `ì•„ì§ ì•ˆ ë“œì‹  ì˜ì–‘ì œê°€ ${missed.length}ê°œ ìˆì–´ìš”!\n${names}`,
    icon: 'icon.png'
  });
  sessionStorage.setItem(notifKey, '1');
}

setInterval(() => { checkAlarms(); checkEveningReminder(); }, 30000);
checkAlarms();
checkEveningReminder();

// --- Escape HTML ---
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// --- Guide Toggle ---
function toggleGuide(btn) {
  btn.classList.toggle('open');
  document.getElementById('guideBody').classList.toggle('open');
}

// --- Calendar Heatmap ---
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();

function renderCalendar() {
  const list = loadSupplements();
  const records = loadRecords();
  const container = document.getElementById('calendarHeatmap');

  if (list.length === 0) {
    container.innerHTML = '';
    return;
  }

  const totalSupps = list.length;
  const year = calendarYear;
  const month = calendarMonth;
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const today = new Date();
  const todayStr = todayKey();

  const monthNames = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];

  let html = `<div class="calendar-month-label">
    <button class="calendar-nav" onclick="changeCalMonth(-1)">â—€</button>
    <span>${year}ë…„ ${monthNames[month]}</span>
    <button class="calendar-nav" onclick="changeCalMonth(1)">â–¶</button>
  </div>`;

  html += '<div class="calendar-grid">';
  const weekdays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  weekdays.forEach(d => { html += `<div class="calendar-weekday">${d}</div>`; });

  const startDow = firstDay.getDay();
  for (let i = 0; i < startDow; i++) {
    html += '<div class="calendar-day empty"></div>';
  }

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = dateKey === todayStr;
    const isFuture = new Date(year, month, d) > today;

    if (isFuture) {
      html += `<div class="calendar-day future">${d}</div>`;
      continue;
    }

    const dayRec = records[dateKey] || [];
    const takenCount = list.filter(s => dayRec.includes(s.id)).length;
    const rate = totalSupps > 0 ? takenCount / totalSupps : 0;

    let level = 0;
    if (rate > 0 && rate < 0.25) level = 1;
    else if (rate >= 0.25 && rate < 0.5) level = 2;
    else if (rate >= 0.5 && rate < 1) level = 3;
    else if (rate >= 1) level = 4;

    const stamp = level === 4 ? '<span class="day-stamp">ì ë¦½ì™„ë£Œ</span>' : '';
    html += `<div class="calendar-day level-${level} ${isToday ? 'today' : ''}" title="${dateKey}: ${takenCount}/${totalSupps} ë³µìš©" style="cursor:pointer" onclick="openDateCheck('${dateKey}')">${d}${stamp}</div>`;
  }

  html += '</div>';

  html += `<div class="calendar-legend">
    <span>ë¶€ì¡±</span>
    <div class="calendar-legend-box" style="background:var(--bg-tertiary)"></div>
    <div class="calendar-legend-box" style="background:#dbeafe"></div>
    <div class="calendar-legend-box" style="background:#93c5fd"></div>
    <div class="calendar-legend-box" style="background:#3b82f6"></div>
    <div class="calendar-legend-box" style="background:#1d4ed8"></div>
    <span>ì™„ë²½</span>
  </div>`;

  // Monthly savings summary
  let monthPerfect = 0;
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dk = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (new Date(year, month, d) > today) continue;
    const dr = records[dk] || [];
    if (list.every(s => dr.includes(s.id))) monthPerfect++;
  }
  const monthSavings = monthPerfect * 167;
  html += `<div class="calendar-savings-summary">ğŸ’° ì´ ì ë¦½ê¸ˆ: <span>${monthSavings.toLocaleString()}ì›</span></div>`;

  container.innerHTML = html;
}

function changeCalMonth(delta) {
  calendarMonth += delta;
  if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
  if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
  renderCalendar();
}

function openDateCheck(dateKey) {
  const parts = dateKey.split('-');
  selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  // Switch to today tab
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('.nav-item[data-tab="today"]').classList.add('active');
  document.getElementById('today').classList.add('active');
  renderToday();
}

// --- Badge / Achievement System ---
const BADGES_KEY = 'supp_badges';
const CHECK_TIMES_KEY = 'supp_check_times';

const BADGES = [
  // ì—°ì† ë³µìš©
  { id: 'first_step', icon: 'ğŸ‘£', name: 'ì²« ê±¸ìŒ', desc: 'ì²« ë³µìš© ì²´í¬', category: 'ì—°ì† ë³µìš©',
    check: () => getTotalChecks() >= 1 },
  { id: 'streak_3', icon: 'ğŸŒ±', name: '3ì¼ ì—°ì†', desc: '3ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 3 },
  { id: 'perfect_week', icon: 'â­', name: 'í¼í™íŠ¸ ìœ„í¬', desc: '7ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 7 },
  { id: 'two_week', icon: 'ğŸƒ', name: '2ì£¼ ë§ˆë¼í†¤', desc: '14ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 14 },
  { id: 'perfect_month', icon: 'ğŸ†', name: 'í¼í™íŠ¸ ë¨¼ìŠ¤', desc: '30ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 30 },
  { id: 'ironman', icon: 'ğŸ’', name: 'ì² ì¸', desc: '100ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 100 },
  { id: 'year_master', icon: 'ğŸ‘‘', name: '1ë…„ ë§ˆìŠ¤í„°', desc: '365ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì—°ì† ë³µìš©',
    check: () => calculateStreak() >= 365 },

  // ëˆ„ì  ë³µìš©
  { id: 'total_10', icon: 'ğŸ’Š', name: '10ì•Œ ëŒíŒŒ', desc: 'ì´ 10íšŒ ë³µìš© ì²´í¬', category: 'ëˆ„ì  ë³µìš©',
    check: () => getTotalChecks() >= 10 },
  { id: 'total_100', icon: 'ğŸ’ª', name: '100ì•Œ í´ëŸ½', desc: 'ì´ 100íšŒ ë³µìš© ì²´í¬', category: 'ëˆ„ì  ë³µìš©',
    check: () => getTotalChecks() >= 100 },
  { id: 'total_500', icon: 'ğŸ›¡ï¸', name: '500ì•Œ ì „ì‚¬', desc: 'ì´ 500íšŒ ë³µìš© ì²´í¬', category: 'ëˆ„ì  ë³µìš©',
    check: () => getTotalChecks() >= 500 },
  { id: 'total_1000', icon: 'ğŸ”±', name: '1000ì•Œ ì „ì„¤', desc: 'ì´ 1000íšŒ ë³µìš© ì²´í¬', category: 'ëˆ„ì  ë³µìš©',
    check: () => getTotalChecks() >= 1000 },

  // íŠ¹ìˆ˜ ì—…ì 
  { id: 'early_bird', icon: 'ğŸ¤', name: 'ì–¼ë¦¬ë²„ë“œ', desc: 'ì˜¤ì „ 7ì‹œ ì´ì „ì— ì²´í¬', category: 'íŠ¹ìˆ˜ ì—…ì ',
    check: () => hasCheckBefore7() },
  { id: 'night_owl', icon: 'ğŸ¦‰', name: 'ì˜¬ë¹¼ë¯¸', desc: 'ë°¤ 10ì‹œ ì´í›„ì— ì²´í¬', category: 'íŠ¹ìˆ˜ ì—…ì ',
    check: () => hasCheckAfter22() },
  { id: 'full_manager', icon: 'ğŸ“‹', name: 'í’€ ê´€ë¦¬ì', desc: '5ì¢… ì´ìƒ ì˜ì–‘ì œ ë“±ë¡', category: 'íŠ¹ìˆ˜ ì—…ì ',
    check: () => loadSupplements().length >= 5 },
  { id: 'health_mania', icon: 'ğŸ§¬', name: 'ê±´ê°• ë§¤ë‹ˆì•„', desc: '8ì¢… ì´ìƒ ì˜ì–‘ì œ ë“±ë¡', category: 'íŠ¹ìˆ˜ ì—…ì ',
    check: () => loadSupplements().length >= 8 },
  { id: 'consistency', icon: 'ğŸ“ˆ', name: 'ê¾¸ì¤€í•¨ì˜ í˜', desc: 'ìµœê·¼ 30ì¼ ë³µìš©ë¥  90% ì´ìƒ', category: 'íŠ¹ìˆ˜ ì—…ì ',
    check: () => getLast30DaysRate() >= 90 },

  // ì‹œê°„ëŒ€ ì—…ì 
  { id: 'monday_miracle', icon: 'ğŸŒŸ', name: 'ì›”ìš”ì¼ì˜ ê¸°ì ', desc: 'ì›”ìš”ì¼ 5ë²ˆ ì „ì²´ ë³µìš©', category: 'ì‹œê°„ëŒ€ ì—…ì ',
    check: () => getMondayFullCount() >= 5 },
  { id: 'no_weekend_off', icon: 'ğŸ—“ï¸', name: 'ì£¼ë§ë„ ì‰¬ì§€ ì•Šì•„', desc: 'ì£¼ë§ í¬í•¨ 7ì¼ ì—°ì† ì „ì²´ ë³µìš©', category: 'ì‹œê°„ëŒ€ ì—…ì ',
    check: () => hasWeekendStreak7() },
  { id: 'new_year', icon: 'ğŸŠ', name: 'ìƒˆí•´ ê²°ì‹¬', desc: '1ì›” 1ì¼ ì „ì²´ ë³µìš©', category: 'ì‹œê°„ëŒ€ ì—…ì ',
    check: () => hasNewYearFull() },
];

function loadBadges() {
  return JSON.parse(localStorage.getItem(BADGES_KEY) || '{}');
}
function saveBadges(b) {
  localStorage.setItem(BADGES_KEY, JSON.stringify(b));
}
function loadCheckTimes() {
  return JSON.parse(localStorage.getItem(CHECK_TIMES_KEY) || '{}');
}
function saveCheckTimes(ct) {
  localStorage.setItem(CHECK_TIMES_KEY, JSON.stringify(ct));
}

function getTotalChecks() {
  const records = loadRecords();
  let total = 0;
  Object.values(records).forEach(arr => { total += arr.length; });
  return total;
}

function getLast30DaysRate() {
  const list = loadSupplements();
  if (list.length === 0) return 0;
  const records = loadRecords();
  let possible = 0, taken = 0;
  for (let i = 0; i < 30; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const dk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const dayRec = records[dk] || [];
    list.forEach(s => {
      possible++;
      if (dayRec.includes(s.id)) taken++;
    });
  }
  return possible > 0 ? Math.round(taken / possible * 100) : 0;
}

function getMondayFullCount() {
  const list = loadSupplements();
  if (list.length === 0) return 0;
  const records = loadRecords();
  let count = 0;
  Object.keys(records).forEach(dk => {
    const parts = dk.split('-');
    const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    if (d.getDay() === 1) { // Monday
      const dayRec = records[dk] || [];
      if (list.every(s => dayRec.includes(s.id))) count++;
    }
  });
  return count;
}

function hasWeekendStreak7() {
  const streak = calculateStreak();
  if (streak < 7) return false;
  // Check if the 7-day streak includes at least one Saturday and one Sunday
  const d = new Date();
  const records = loadRecords();
  const list = loadSupplements();
  if (list.length === 0) return false;

  const todayK = todayKey();
  const todayRec = records[todayK] || [];
  const todayDone = list.every(s => todayRec.includes(s.id));
  if (!todayDone) d.setDate(d.getDate() - 1);

  let hasSat = false, hasSun = false;
  for (let i = 0; i < 7; i++) {
    const dow = d.getDay();
    if (dow === 0) hasSun = true;
    if (dow === 6) hasSat = true;
    d.setDate(d.getDate() - 1);
  }
  return hasSat && hasSun;
}

function hasNewYearFull() {
  const list = loadSupplements();
  if (list.length === 0) return false;
  const records = loadRecords();
  // Check any year's Jan 1
  return Object.keys(records).some(dk => {
    if (dk.endsWith('-01-01')) {
      const dayRec = records[dk] || [];
      return list.every(s => dayRec.includes(s.id));
    }
    return false;
  });
}

function hasCheckBefore7() {
  const ct = loadCheckTimes();
  return Object.values(ct).some(time => {
    const h = parseInt(time.split(':')[0]);
    return h < 7;
  });
}

function hasCheckAfter22() {
  const ct = loadCheckTimes();
  return Object.values(ct).some(time => {
    const h = parseInt(time.split(':')[0]);
    return h >= 22;
  });
}

function saveCheckTime(suppId) {
  const ct = loadCheckTimes();
  const now = new Date();
  const hm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  ct[`${todayKey()}_${suppId}`] = hm;
  saveCheckTimes(ct);
}

let badgePopupQueue = [];
let badgePopupShowing = false;

function checkBadges() {
  const earned = loadBadges();
  const newBadges = [];
  BADGES.forEach(b => {
    if (!earned[b.id]) {
      try {
        if (b.check()) {
          earned[b.id] = todayKey();
          newBadges.push(b);
        }
      } catch(e) {}
    }
  });
  if (newBadges.length > 0) {
    saveBadges(earned);
    newBadges.forEach(b => badgePopupQueue.push(b));
    if (!badgePopupShowing) showNextBadgePopup();
  }
}

function recheckBadges() {
  const earned = loadBadges();
  let changed = false;
  BADGES.forEach(b => {
    if (earned[b.id]) {
      try {
        if (!b.check()) {
          delete earned[b.id];
          changed = true;
        }
      } catch(e) {}
    }
  });
  if (changed) {
    saveBadges(earned);
    renderBadges();
  }
}

function showNextBadgePopup() {
  if (badgePopupQueue.length === 0) {
    badgePopupShowing = false;
    return;
  }
  badgePopupShowing = true;
  const badge = badgePopupQueue.shift();
  showBadgePopup(badge);
}

function showBadgePopup(badge) {
  document.getElementById('badgePopupIcon').textContent = badge.icon;
  document.getElementById('badgePopupName').textContent = badge.name;
  document.getElementById('badgePopupDesc').textContent = badge.desc;
  document.getElementById('badgePopup').classList.add('active');
  fireBigConfetti();
  vibrate([50, 50, 100]);
}

function closeBadgePopup() {
  document.getElementById('badgePopup').classList.remove('active');
  setTimeout(showNextBadgePopup, 300);
}

document.getElementById('badgePopup').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeBadgePopup();
});

function renderBadges() {
  const container = document.getElementById('badgeSection');
  const list = loadSupplements();
  if (list.length === 0) {
    container.innerHTML = '';
    return;
  }
  const earned = loadBadges();
  const categories = ['ì—°ì† ë³µìš©', 'ëˆ„ì  ë³µìš©', 'íŠ¹ìˆ˜ ì—…ì ', 'ì‹œê°„ëŒ€ ì—…ì '];
  const earnedCount = Object.keys(earned).length;

  let html = `<div class="badge-section">
    <h3>ë±ƒì§€ (${earnedCount}/${BADGES.length})</h3>`;

  categories.forEach(cat => {
    const catBadges = BADGES.filter(b => b.category === cat);
    html += `<div class="badge-category-label">${cat}</div>`;
    html += '<div class="badge-grid">';
    catBadges.forEach(b => {
      const isUnlocked = !!earned[b.id];
      html += `
        <div class="badge-card ${isUnlocked ? 'unlocked' : 'locked'}" onclick="openBadgeDetail('${b.id}')" style="cursor:pointer">
          <span class="badge-icon">${b.icon}</span>
          <div class="badge-name">${esc(b.name)}</div>
          <div class="badge-desc">${esc(b.desc)}</div>
          ${isUnlocked ? `<div class="badge-date">${earned[b.id]}</div>` : ''}
        </div>`;
    });
    html += '</div>';
  });

  html += '</div>';
  container.innerHTML = html;
}

// --- Badge Detail Modal ---
function openBadgeDetail(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = loadBadges();
  const isUnlocked = !!earned[badge.id];

  document.getElementById('badgeDetailIcon').textContent = badge.icon;
  document.getElementById('badgeDetailName').textContent = badge.name;
  document.getElementById('badgeDetailDesc').textContent = badge.desc;

  const content = document.getElementById('badgeDetailContent');
  content.className = 'badge-detail-content' + (isUnlocked ? ' unlocked' : '');

  const status = document.getElementById('badgeDetailStatus');
  if (isUnlocked) {
    status.className = 'badge-detail-status earned';
    status.textContent = 'ë‹¬ì„± ' + earned[badge.id];
  } else {
    status.className = 'badge-detail-status locked';
    status.textContent = 'ë¯¸ë‹¬ì„±';
  }

  document.getElementById('badgeDetail').classList.add('active');
}

function closeBadgeDetail() {
  document.getElementById('badgeDetail').classList.remove('active');
}

document.getElementById('badgeDetail').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeBadgeDetail();
});

// --- PWA Service Worker ---
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function() {});
}

// --- Init ---
checkNotifPermission();
renderToday();
</script>
</body>
</html>
